from collections.abc import Sequence
import functools
import logging
import traceback

from telegram import InlineKeyboardButton, InlineKeyboardMarkup, Update
from telegram.ext import (
    Application,
    CallbackQueryHandler,
    CommandHandler,
    ConversationHandler,
    ContextTypes,
    MessageHandler,
    filters,
)

import check_sid
import config
import database_fns
import photos

logger = logging.getLogger(__name__)

# Set the logging level to DEBUG
logging.basicConfig(
    level=logging.DEBUG,
    format="%(asctime)s - %(name)s - %(levelname)s - %(message)s",
)

# Define conversation states
MENU, ASKED_FOR_INFO_OPTIONS, MOSCOW_ASKED_IF_CHECKED_SID, MOSCOW_ASKED_FOR_SID = range(
    4
)


async def photo_message_handler(
    update: Update, context: ContextTypes.DEFAULT_TYPE
) -> None:
    if update.effective_chat.id not in config.REPLY_WITH_PHOTO_ID_USER_IDS:
        logger.info(
            "Unauthorized user attempted to send a photo: "
            f"{update.effective_chat.id}. Allowed users: {config.REPLY_WITH_PHOTO_ID_USER_IDS}"
        )
        return

    # Extract the file ID of the last photo in the message (highest resolution)
    photo_file_id = update.message.photo[-1].file_id

    # Reply to the user with the photo file ID
    await context.bot.send_message(
        chat_id=update.effective_chat.id,
        text=f"Photo ID: {photo_file_id}",
    )


async def _send_delimiter(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    await context.bot.send_message(
        chat_id=update.effective_chat.id,
        text="üü¶" * 10,
    )


def _get_info_keyboard() -> list[list[InlineKeyboardButton]]:
    return [
        [InlineKeyboardButton("–ó–∞—á–µ–º –Ω—É–∂–µ–Ω —ç—Ç–æ—Ç –±–æ—Ç?", callback_data="why_bot_exists")],
        [
            InlineKeyboardButton(
                "–ì–æ–ª–æ—Å—É—é –Ω–∞ —É—á–∞—Å—Ç–∫–µ", callback_data="moscow_in_person_info"
            )
        ],
        [
            InlineKeyboardButton(
                "–ì–æ–ª–æ—Å—É—é –≤ –î–≠–ì, –ø—Ä–æ–ø–∏—Å–∫–∞ –≤ –ú–æ—Å–∫–≤–µ",
                callback_data="voting_in_moscow_deg",
            )
        ],
        [
            InlineKeyboardButton(
                "–ì–æ–ª–æ—Å—É—é –≤ –î–≠–ì, –ø—Ä–æ–ø–∏—Å–∫–∞ –Ω–µ –≤ –ú–æ—Å–∫–≤–µ",
                callback_data="voting_in_region_deg",
            )
        ],
        [InlineKeyboardButton("–ö–∞–∫ —É—Å—Ç—Ä–æ–µ–Ω –î–≠–ì?", callback_data="how_deg_works")],
    ]


def _get_menu_keyboard() -> list[list[InlineKeyboardButton]]:
    return [
        [
            InlineKeyboardButton(
                "–î–≠–ì –ú–æ—Å–∫–≤—ã: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏",
                callback_data="moscow_check_sid",
            ),
        ],
        [
            InlineKeyboardButton(
                "–ì–æ–ª–æ—Å—É—é –±—É–º–∞–∂–Ω—ã–º –±—é–ª–ª–µ—Ç–µ–Ω–µ–º –≤ –ª—é–±–æ–º —Ä–µ–≥–∏–æ–Ω–µ",
                callback_data="voting_in_person_redirect",
            ),
        ],
        [
            InlineKeyboardButton("–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø—Ä–æ –î–≠–ì", callback_data="info"),
        ],
    ]


async def start(
    update: Update,
    context: ContextTypes.DEFAULT_TYPE,
) -> int:
    logging.debug(f"Got start from {update.effective_chat.id}")

    database_fns.ensure_user_in_db(update)

    query = update.callback_query
    if query is not None:
        await query.answer()
        await query.edit_message_reply_markup(reply_markup=None)

    reply_markup = InlineKeyboardMarkup(_get_menu_keyboard())
    # Example of sending photos (replace 'URL_or_file_id' with actual URLs or file identifiers)
    # await context.bot.send_photo(chat_id=update.effective_chat.id, photo='URL_or_file_id_of_your_photo')
    # await context.bot.send_photo(chat_id=update.effective_chat.id, photo='URL_or_file_id_of_your_second_photo')

    await context.bot.send_photo(
        chat_id=update.effective_chat.id,
        photo=photos.ENTRANCE_PHOTO_ID,
    )

    await context.bot.send_message(
        chat_id=update.effective_chat.id,
        text="""
–≠—Ç–æ –±–æ—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≥–æ–ª–æ—Å–æ–≤ –¥–∏—Å—Ç–∞–Ω—Ü–∏–æ–Ω–Ω–æ–≥–æ —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ–≥–æ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è (–î–≠–ì). –ù–µ –¥–∞–π—Ç–µ —É–∫—Ä–∞—Å—Ç—å —Å–≤–æ–π –≥–æ–ª–æ—Å!

–ü—Ä–∏ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–∏ –≤ –î–≠–ì –≤ –±—é–ª–ª–µ—Ç–µ–Ω–µ –ø–æ—Å—Ç–∞–≤—å—Ç–µ –≥–∞–ª–æ—á–∫—É ¬´–•–æ—á—É –ø–æ–ª—É—á–∏—Ç—å –∞–¥—Ä–µ—Å –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≤ –±–ª–æ–∫—á–µ–π–Ω–µ¬ª, —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∞–¥—Ä–µ—Å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏.

–°–µ–π—á–∞—Å –±–æ—Ç –º–æ–∂–µ—Ç –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –î–≠–ì –ú–æ—Å–∫–≤—ã, –∏–ª–∏ —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å –æ–±—â—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é.

–ü–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –≤ —Ä–∞–∑–¥–µ–ª–∞—Ö –Ω–∏–∂–µ ‚¨áÔ∏è
""".strip(),
        reply_markup=reply_markup,
    )

    return MENU


async def redirect_to_dobrostat(
    update: Update,
    context: ContextTypes.DEFAULT_TYPE,
):
    query = update.callback_query
    if query is not None:
        await query.answer()
        await query.edit_message_reply_markup(reply_markup=None)

    await _send_delimiter(update, context)

    await context.bot.send_photo(
        chat_id=update.effective_chat.id,
        photo=photos.MOSCOW_IN_PERSON_INFO[0],
    )

    reply_markup = InlineKeyboardMarkup(_get_menu_keyboard())

    await context.bot.send_message(
        chat_id=update.effective_chat.id,
        text="""
–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é –∑–∞–ø–æ–ª–µ–Ω–Ω–æ–≥–æ –±—É–∞–∂–Ω–æ–≥–æ –±—é–ª–ª–µ—Ç–µ–Ω—è –≤ –±–æ—Ç–∞ @dobrostatbot.

–ë–æ—Ç –≤–µ–¥—ë—Ç –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–π —É—á—ë—Ç –≥–æ–ª–æ—Å–æ–≤.

–í –ú–æ—Å–∫–≤–µ –Ω–µ –∑–∞–±—ã–≤–∞–π—Ç–µ, —á—Ç–æ –±—É–º–∞–∂–Ω—ã–π –±—é–ª–ª–µ—Ç–µ–Ω—å –Ω–∞–¥–æ –ø—Ä–æ—Å–∏—Ç—å –æ—Ç–¥–µ–ª—å–Ω–æ. –í–∞–º –ø—Ä–µ–¥–ª–æ–∂–∞—Ç –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞—Ç—å —á–µ—Ä–µ–∑ —Ç–µ—Ä–º–∏–Ω–∞–ª: —ç—Ç–æ –î–≠–ì. –ù–µ–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π –∏ –Ω–µ–ø—Ä–æ–≤–µ—Ä—è–µ–º—ã–π.
""".strip(),
        reply_markup=reply_markup,
    )

    return MENU


async def moscow_check_sid_handler(
    update: Update,
    context: ContextTypes.DEFAULT_TYPE,
) -> int:
    query = update.callback_query
    assert query is not None
    assert update.effective_chat is not None

    await query.answer()

    await query.edit_message_reply_markup(reply_markup=None)

    reply_markup = InlineKeyboardMarkup(
        [
            [
                InlineKeyboardButton("–ù–∞–∑–∞–¥", callback_data="back"),
            ],
            [
                InlineKeyboardButton(
                    "–î–∞, —è –ø–æ—Å—Ç–∞–≤–∏–ª –≥–∞–ª–æ—á–∫—É",
                    callback_data="yes",
                ),
            ],
            [
                InlineKeyboardButton(
                    "–ù–µ—Ç, —è –Ω–µ —Å—Ç–∞–≤–∏–ª –≥–∞–ª–æ—á–µ–∫ –ø—Ä–æ–≤–µ—Ä–∫–∏ –≥–æ–ª–æ—Å–∞",
                    callback_data="no",
                ),
            ],
        ]
    )

    await context.bot.send_message(
        chat_id=update.effective_chat.id,
        text="""
–î–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≥–æ–ª–æ—Å–∞ –≤—ã –±—ã–ª–∏ –¥–æ–ª–∂–Ω—ã —Å–¥–µ–ª–∞—Ç—å:

- –ü–æ—Å—Ç–∞–≤–∏—Ç—å –≥–∞–ª–æ—á–∫—É ¬´–•–æ—á—É –ø–æ–ª—É—á–∏—Ç—å –∞–¥—Ä–µ—Å –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≤ –±–ª–æ–∫—á–µ–π–Ω–µ¬ª –≤ –±—é–ª–ª–µ—Ç–µ–Ω–µ.
- –ó–∞–ø–∏—Å–∞—Ç—å –ø–æ–ª—É—á–µ–Ω–Ω—ã–π —à–∏—Ñ—Ä.

–í—ã —ç—Ç–æ —Å–¥–µ–ª–∞–ª–∏?
""".strip(),
        reply_markup=reply_markup,
    )

    return MOSCOW_ASKED_IF_CHECKED_SID


async def moscow_yes_i_checked_sid(
    update: Update,
    context: ContextTypes.DEFAULT_TYPE,
) -> int:
    query = update.callback_query
    assert query is not None
    assert update.effective_chat is not None

    await query.answer()

    await query.edit_message_reply_markup(reply_markup=None)

    reply_markup = InlineKeyboardMarkup(
        [[InlineKeyboardButton("–í –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data="back")]]
    )

    msg = await context.bot.send_message(
        chat_id=update.effective_chat.id,
        text=f"""
–ü—Ä–∏—à–ª–∏—Ç–µ –º–Ω–µ –ø–æ–ª—É—á–µ–Ω–Ω—ã–π –∞–¥—Ä–µ—Å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏.

–≠—Ç–æ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Å—Ç—Ä–æ–∫–∞ –∏–∑ –±—É–∫–≤, —Ü–∏—Ñ—Ä –∏ –¥–µ—Ñ–∏—Å–æ–≤.

–ü—Ä–∏–º–µ—Ä: {config.HARDCODED_MOSCOW_VALID_SID}
""".strip(),
        reply_markup=reply_markup,
    )
    context.user_data["delete_keyboard_message_id"] = msg.message_id

    return MOSCOW_ASKED_FOR_SID


async def moscow_sid_message_handler(
    update: Update,
    context: ContextTypes.DEFAULT_TYPE,
) -> int:
    assert update.message is not None

    user_text = update.message.text

    assert user_text is not None

    user_text = user_text.strip()

    reply_buttons = [[InlineKeyboardButton("–í –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data="back")]]

    user_data = context.user_data
    delete_keyboard_message_id = user_data.get("delete_keyboard_message_id")
    if delete_keyboard_message_id:
        await context.bot.edit_message_reply_markup(
            chat_id=update.effective_chat.id,
            message_id=delete_keyboard_message_id,
            reply_markup=None,  # This removes the keyboard
        )

    if not check_sid.is_valid_sid(user_text):
        logging.info(f"Entered invalid SID: {user_text}")
        msg = await context.bot.send_message(
            chat_id=update.effective_chat.id,
            text="""
–≠—Ç–æ –Ω–µ –ø–æ—Ö–æ–∂–µ –Ω–∞ –∞–¥—Ä–µ—Å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.
    """.strip(),
            reply_markup=InlineKeyboardMarkup(reply_buttons),
        )
        user_data["delete_keyboard_message_id"] = msg.message_id
        return MOSCOW_ASKED_FOR_SID

    try:
        sid_data = check_sid.query_sid(user_text)
    except ValueError as e:
        msg = await context.bot.send_message(
            chat_id=update.effective_chat.id,
            text=f"""
–£–ø—Å, —Å –≤–∞—à–µ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–µ–π —è–≤–Ω–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫:

{e}

–ù–∞–ø–∏—à–∏—Ç–µ @PeterZhizhin. –ß—Ç–æ–±—ã –≤—ã–π—Ç–∏ –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –Ω–∞–∂–º–∏—Ç–µ /start.
    """.strip(),
            reply_markup=InlineKeyboardMarkup(reply_buttons),
        )
        user_data["delete_keyboard_message_id"] = msg.message_id
        logging.exception(f"Error while querying SID:\n{traceback.format_exc()}")

        database_fns.persist_sid_data(
            sid=user_text,
            error_info=str(e),
            sid_data=None,
        )

        return await start(update, context)

    database_fns.persist_sid_data(
        sid=user_text,
        error_info=None,
        sid_data=sid_data,
    )

    if sid_data is None:
        msg = await context.bot.send_message(
            chat_id=update.effective_chat.id,
            text="""
–≠—Ç–æ—Ç –∞–¥—Ä–µ—Å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –ú–æ—Å–∫–æ–≤—Å–∫–æ–≥–æ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è.

–î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è 1 —Ä–∞–∑ –≤ —á–∞—Å. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.
–ï—Å–ª–∏ –ø—Ä–æ—à–ª–æ –º–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏, –∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –Ω–µ—Ç, —Ç–æ –Ω–∞–ø–∏—à–∏—Ç–µ @PeterZhizhin.

–í–≤–µ–¥–∏—Ç–µ –¥—Ä—É–≥–æ–π SID –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É —á—Ç–æ–±—ã –≤—ã–π—Ç–∏ –≤ –º–µ–Ω—é.
    """.strip(),
            reply_markup=InlineKeyboardMarkup(reply_buttons),
        )
        user_data["delete_keyboard_message_id"] = msg.message_id

        return MOSCOW_ASKED_FOR_SID

    sid_data_formatted = sid_data.human_readable()

    reply_buttons.append(
        [
            InlineKeyboardButton(
                "–ß—Ç–æ –∑–∞ –ø–æ–ª–µ data?",
                callback_data="moscow_what_is_data_field",
            ),
        ]
    )

    msg = await context.bot.send_message(
        chat_id=update.effective_chat.id,
        text=f"""
{sid_data_formatted}

–ß—Ç–æ-—Ç–æ –Ω–µ —Ç–∞–∫? –ù–∞–ø–∏—à–∏—Ç–µ @PeterZhizhin.

–ü—Ä–∏—à–ª–∏—Ç–µ –µ—â—ë –æ–¥–∏–Ω –∞–¥—Ä–µ—Å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É —á—Ç–æ–±—ã –≤—ã–π—Ç–∏ –≤ –º–µ–Ω—é.
""".strip(),
        reply_markup=InlineKeyboardMarkup(reply_buttons),
    )
    user_data["delete_keyboard_message_id"] = msg.message_id

    return MOSCOW_ASKED_FOR_SID


async def moscow_what_is_data_field_handler(
    update: Update,
    context: ContextTypes.DEFAULT_TYPE,
) -> int:
    query = update.callback_query
    assert query is not None
    assert update.effective_chat is not None

    await query.answer()

    await query.edit_message_reply_markup(reply_markup=None)

    reply_buttons = [[InlineKeyboardButton("–í –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data="back")]]

    msg = await context.bot.send_message(
        chat_id=update.effective_chat.id,
        text="""
–í —ç—Ç–æ–º –ø–æ–ª–µ –ø–æ-–∏–¥–µ–µ –¥–æ–ª–∂–µ–Ω —Ö—Ä–∞–Ω–∏—Ç—å—Å—è –≤–∞—à –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π –≥–æ–ª–æ—Å.

–î–æ—Å—Ç–æ–≤–µ—Ä–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, —Ç–∞–∫ —ç—Ç–æ –∏–ª–∏ –Ω–µ—Ç - –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ.

–ö–æ–≥–¥–∞ –≤—ã –≥–æ–ª–æ—Å—É–µ—Ç–µ, –≥–æ–ª–æ—Å —à–∏—Ñ—Ä—É–µ—Ç—Å—è –ø–µ—Ä–≤—ã–π —Ä–∞–∑ —É –≤–∞—Å –≤ –±—Ä–∞—É–∑–µ—Ä–µ –∫–ª—é—á–æ–º, –∫–æ—Ç–æ—Ä—ã–π –¥–µ–ª—è—Ç –Ω–∞ –º–Ω–æ–≥–æ —á–∞—Å—Ç–µ–π –∏ –∫–æ—Ç–æ—Ä—ã–π –≤ –º–æ–º–µ–Ω—Ç –ø–æ–¥—Å—á—ë—Ç–∞ –ø—É–±–ª–∏–∫—É—é—Ç –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è.
–î–∞–ª–µ–µ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∏ —à–∏—Ñ—Ä—É—é—Ç –≥–æ–ª–æ—Å –≤—Ç–æ—Ä–æ–π —Ä–∞–∑, —É–∂–µ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –∫–ª—é—á–∞, –¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ —Ç–æ–ª—å–∫–æ –î–ò–¢ –ú–æ—Å–∫–≤—ã.

–ò–∑-–∑–∞ —ç—Ç–æ–≥–æ –≤ —ç—Ç–æ–π —Å–∏—Å—Ç–µ–º–µ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –ø–æ–¥–≤–µ—Å—Ç–∏ –∏—Ç–æ–≥–∏.

–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∏ –Ω–∞–∑—ã–≤–∞—é—Ç "—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã–º —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ–º".

–¢–∞–∫–æ–π –º–µ—Ö–∞–Ω–∏–∑–º —É–ø—Ä–æ—â–∞–µ—Ç –ª—é–±—ã–µ —Ñ–∞–ª—å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏: —Ç–∞–∫ –∫–∞–∫ –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞—Ç—å –≥–æ–ª–æ—Å–∞ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ, —Ç–æ –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫—É –Ω–µ –ø–æ–¥–º–µ–Ω–∏–ª–∏ —Ç–æ–∂–µ –Ω–µ –ø–æ–ª—É—á–∏—Ç—Å—è.

–í–≤–µ–¥–∏—Ç–µ –µ—â—ë –æ–¥–∏–Ω SID –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É —á—Ç–æ–±—ã –≤—ã–π—Ç–∏ –≤ –º–µ–Ω—é.
""".strip(),
        reply_markup=InlineKeyboardMarkup(reply_buttons),
    )
    user_data = context.user_data or {}
    user_data["delete_keyboard_message_id"] = msg.message_id

    return MOSCOW_ASKED_FOR_SID


async def moscow_did_not_check_sid(
    update: Update,
    context: ContextTypes.DEFAULT_TYPE,
) -> int:
    query = update.callback_query
    assert query is not None
    assert update.effective_chat is not None

    await query.answer()

    await query.edit_message_reply_markup(reply_markup=None)

    await context.bot.send_message(
        chat_id=update.effective_chat.id,
        text="""
–ï—Å–ª–∏ –≤—ã –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–ª–∏ —á–µ—Ä–µ–∑ –≤ –î–≠–ì —á–µ—Ä–µ–∑ –ò–Ω—Ç–µ—Ä–Ω–µ—Ç –∏–ª–∏ –Ω–∞ —É—á–∞—Å—Ç–∫–µ —á–µ—Ä–µ–∑ —Ç–µ—Ä–º–∏–Ω–∞–ª, –Ω–æ –Ω–µ –ø–æ—Å—Ç–∞–≤–∏–ª–∏ –≥–∞–ª–æ—á–∫—É, —Ç–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –≥–æ–ª–æ—Å –Ω–µ –ø–æ–ª—É—á–∏—Ç—Å—è.

–ë–æ–ª–µ–µ —Ç–æ–≥–æ, –≥–æ–ª–æ—Å –æ—á–µ–Ω—å –ª–µ–≥–∫–æ –º–æ–≥—É—Ç –ø–æ–¥–º–µ–Ω–∏—Ç—å. –û–¥–Ω–∞–∫–æ –º—ã –Ω–µ –∑–Ω–∞–µ–º, –±—É–¥—É—Ç –ª–∏ –æ–Ω–∏ —ç—Ç–æ –¥–µ–ª–∞—Ç—å. –ù–æ, –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π, —Å—á–∏—Ç–∞–π—Ç–µ, —á—Ç–æ –≤—ã –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–ª–∏ –∑–∞ –ü—É—Ç–∏–Ω–∞.

–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ –≥–∞–ª–æ—á–∫–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–≤–æ–µ–≥–æ –≥–æ–ª–æ—Å–∞ —Å–≤–æ–∏–º –¥—Ä—É–∑—å—è–º –∏ –∑–Ω–∞–∫–æ–º—ã–º.
""".strip(),
        reply_markup=InlineKeyboardMarkup(
            [
                [
                    InlineKeyboardButton(
                        "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è", callback_data="did_not_check_get_info"
                    )
                ],
            ]
        ),
    )

    return MOSCOW_ASKED_IF_CHECKED_SID


async def ask_for_info_options(
    update: Update,
    context: ContextTypes.DEFAULT_TYPE,
) -> int:
    query = update.callback_query
    assert query is not None
    assert update.effective_chat is not None

    await query.answer()

    await query.edit_message_reply_markup(reply_markup=None)
    await _send_delimiter(update, context)

    reply_markup = InlineKeyboardMarkup(_get_info_keyboard())

    await context.bot.send_message(
        chat_id=update.effective_chat.id,
        text="–í—ã–±–∏—Ä–∏—Ç–µ –ø—É–Ω–∫—Ç –º–µ–Ω—é:",
        reply_markup=reply_markup,
    )

    return ASKED_FOR_INFO_OPTIONS


async def menu_handler(
    update: Update,
    context: ContextTypes.DEFAULT_TYPE,
    data_override: str | None = None,
) -> int:
    query = update.callback_query
    assert query is not None
    assert update.effective_chat is not None

    await query.answer()

    await query.edit_message_reply_markup(reply_markup=None)
    await _send_delimiter(update, context)

    query_data = query.data if data_override is None else data_override

    # Send new message with information based on the button pressed
    if query_data == "back":
        return await start(update, context)
    if query_data in [
        "why_bot_exists",
        "moscow_in_person_info",
        "voting_in_moscow_deg",
        "voting_in_region_deg",
        "how_deg_works",
    ]:
        image_ids = {
            "moscow_in_person_info": photos.MOSCOW_IN_PERSON_INFO,
            "voting_in_moscow_deg": photos.VOTING_IN_MOSCOW_DEG,
            "voting_in_region_deg": photos.VOTING_IN_REGION_DEG,
        }.get(query_data, [])

        if not isinstance(image_ids, list):
            image_ids = [image_ids]

        text = {
            "why_bot_exists": """
–í–æ –≤—Ä–µ–º—è –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è —á–µ—Ä–µ–∑ –î–≠–ì —É –∏–∑–±–∏—Ä–∞—Ç–µ–ª–µ–π –µ—Å—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —É—á—ë—Ç —Å–≤–æ–µ–≥–æ –≥–æ–ª–æ—Å–∞.

–ù–∞ –ø—Ä–∞–∫—Ç–∏–∫–µ, –∏–∑-–∑–∞ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ —ç—Ç–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –º–∞–ª–æ –∫—Ç–æ –ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–∞–∫–æ–π –æ–ø—Ü–∏–µ–π.

–ë–æ—Ç –ø—Ä–∏–∑–≤–∞–Ω —É–ø—Ä–æ—Å—Ç–∏—Ç—å —Ç–∞–∫—É—é –ø—Ä–æ–≤–µ—Ä–∫—É.

–í–æ –≤—Ä–µ–º—è –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è –±–æ—Ç –ø–æ–∫–∞–∂–µ—Ç, —É—á–∏—Ç—ã–≤–∞–µ—Ç –ª–∏ —Å–∏—Å—Ç–µ–º–∞ –≤–∞—à –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π –≥–æ–ª–æ—Å –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.
–ü–æ—Å–ª–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è, –¥–ª—è –∏–∑–±–∏—Ä–∞—Ç–µ–ª–µ–π –∏–∑ –ú–æ—Å–∫–≤—ã, –±–æ—Ç –ø—Ä–æ–≤–µ—Ä–∏—Ç, –∑–∞ –∫–æ–≥–æ –≤ –∏—Ç–æ–≥–µ —É—á—ë–ª—Å—è –≥–æ–ª–æ—Å.
""".strip(),
            "moscow_in_person_info": """
–¢–†–ï–ë–£–ô–¢–ï –ë–£–ú–ê–ñ–ù–´–ô –ë–Æ–õ–õ–ï–¢–ï–ù–¨. –í–∞–º –±—É–¥—É—Ç –ø—Ä–µ–¥–ª–∞–≥–∞—Ç—å –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞—Ç—å –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ ‚Äî –ù–ï –°–û–ì–õ–ê–®–ê–ô–¢–ï–°–¨.

–¢–µ—Ä–º–∏–Ω–∞–ª—ã –Ω–∞ —É—á–∞—Å—Ç–∫–∞—Ö —ç—Ç–æ —Ç–∞–∫–æ–π –∂–µ –î–≠–ì, –Ω–µ–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π –∏ —Ñ–∞–ª—å—Å–∏—Ñ–∏—Ü–∏—Ä—É–µ–º—ã–π. –ì–æ–ª–æ—Å—É–π—Ç–µ –±—É–º–∞–∂–Ω—ã–º –±—é–ª–ª–µ—Ç–µ–Ω–µ–º.

–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ–≥–æ –±—é–ª–ª–µ—Ç–µ–Ω—è –≤ –±–æ—Ç –Ω–∞—à–∏—Ö –∫–æ–ª–ª–µ–≥: @dobrostatbot. –û–Ω–∏ –≤–µ–¥—É—Ç –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–π –ø–æ–¥—Å—á—ë—Ç –±—É–º–∞–∂–Ω—ã—Ö –±—é–ª–ª–µ—Ç–µ–Ω–µ–π.

–ï—Å–ª–∏ –≤—ã –≤—Å—ë —Ä–∞–≤–Ω–æ –≥–æ–ª–æ—Å—É–µ—Ç–µ —á–µ—Ä–µ–∑ —Ç–µ—Ä–º–∏–Ω–∞–ª, —Ç–æ –≤–µ–¥–∏—Ç–µ —Å–µ–±—è —Ç–∞–∫, —á—Ç–æ –≤—ã –≥–æ–ª–æ—Å—É–µ—Ç–µ —á–µ—Ä–µ–∑ –î–≠–ì.
–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "–ü—Ä–æ–ø–∏—Å–∫–∞ –≤ –ú–æ—Å–∫–≤–µ, –≥–æ–ª–æ—Å—É—é —á–µ—Ä–µ–∑ –î–≠–ì", —á—Ç–æ–±—ã —É–∑–Ω–∞—Ç—å, –∫–∞–∫ –æ–±–µ–∑–æ–ø–∞—Å–∏—Ç—å —Å–≤–æ–π –≥–æ–ª–æ—Å.
""".strip(),
            "voting_in_moscow_deg": """
–í–∞–∂–Ω–æ –ø–æ—Å—Ç–∞–≤–∏—Ç—å –≥–∞–ª–æ—á–∫—É –æ–∫–æ–ª–æ –ø—É–Ω–∫—Ç–∞ ¬´–•–æ—á—É –ø–æ–ª—É—á–∏—Ç—å –∞–¥—Ä–µ—Å –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≤ –±–ª–æ–∫—á–µ–π–Ω–µ¬ª. –û–Ω –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Å–∞–º–æ–º –Ω–∏–∑—É, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –æ—Ç–∂–∞—Ç –∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ —Å–¥–µ–ª–∞–Ω –Ω–µ–∑–∞–º–µ—Ç–Ω—ã–º. 

‚ùóÔ∏è–ï—Å–ª–∏ –Ω–µ –ø—Ä–æ–∂–∞—Ç—å —ç—Ç—É –≥–∞–ª–∫—É, –≥–æ–ª–æ—Å –ª–µ–≥–∫–æ —Å—Ñ–∞–ª—å—Å–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –∏ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ—Ç—Å–ª–µ–¥–∏—Ç—å.‚ùóÔ∏è

–ü–æ—Å–ª–µ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è –≤—ã –ø–æ–ø–∞–¥—ë—Ç–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–µ–π (—Ç—Ä–µ—Ç—å—è –∫–∞—Ä—Ç–∏–Ω–∫–∞).

‚ùóÔ∏è–í–∞–º –Ω—É–∂–Ω–æ –∑–∞–ø–∏—Å–∞—Ç—å —ç—Ç–æ—Ç –Ω–æ–º–µ—Ä (–æ–Ω —Å–æ—Å—Ç–æ–∏—Ç –∏–∑ –±—É–∫–≤, —Ü–∏—Ñ—Ä –∏ –¥–µ—Ñ–∏—Å–æ–≤). –¢–∞–∫ –≤—ã —Å–º–æ–∂–µ—Ç–µ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–∞—à –≥–æ–ª–æ—Å.‚ùóÔ∏è

–ö–æ–≥–¥–∞ –∑–∞–≤–µ—Ä—à–∏—Ç—Å—è –ø–æ–¥—Å—á—ë—Ç, –±–æ—Ç –ø–æ–∫–∞–∂–µ—Ç, –∑–∞ –∫–æ–≥–æ –≤ –∏—Ç–æ–≥–µ —É—á—ë–ª—Å—è –≤–∞—à –≥–æ–ª–æ—Å.
""".strip(),
            "voting_in_region_deg": """
–í —Å–∞–º–æ–º –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–∏ –Ω—É–∂–Ω–æ —Ç–æ–ª—å–∫–æ –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞—Ç—å, –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ø–æ–∫–∞–∂—É—Ç –≤ –ª—é–±–æ–º —Å–ª—É—á–∞–µ.

–ü–æ—Å–ª–µ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è –Ω—É–∂–Ω–æ —Ä–∞—Å–∫—Ä—ã—Ç—å –ø–æ–ª–µ "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏" –∏ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –¥–≤–µ —Å—Ç—Ä–æ–∫–∏:
- –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
- senderPublicKey

‚ùóÔ∏è–ó–∞–ø–∏—à–∏—Ç–µ —ç—Ç–∏ –Ω–æ–º–µ—Ä–∞, –≤–æ –≤—Ä–µ–º—è –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è –±–æ—Ç –ø–æ–∑–≤–æ–ª–∏—Ç –ø–æ–≤–µ—Ä–∏—Ç—å —É—á—ë—Ç –≥–æ–ª–æ—Å–∞‚ùóÔ∏è

–ü–æ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—É —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –º–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å –ø–æ–ª–Ω—É—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –∏ —Å—Ä–∞–≤–Ω–∏—Ç—å –ø–æ–ª–µ senderPublicKey, –∫–æ—Ç–æ—Ä–æ–µ –≤—ã —Å–æ—Ö—Ä–∞–Ω–∏–ª–∏.

–§–µ–¥–µ—Ä–∞–ª—å–Ω—ã–π –î–≠–ì –Ω–µ —Ä–∞—Å–∫—Ä—ã–≤–∞–µ—Ç –Ω–∏–∫–æ–º—É, –∫–∞–∫ —É—á—ë–ª—Å—è –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π –≥–æ–ª–æ—Å. –ë–æ—Ç –ø–æ–∫–∞–∂–µ—Ç, —á—Ç–æ –≤–∞—à –≥–æ–ª–æ—Å –ø–æ–ø–∞–ª –≤ –æ–±—â–∏–π –∏—Ç–æ–≥.

–ö–æ–≥–¥–∞ –ø–æ–¥–≤–µ–¥—É—Ç –∏—Ç–æ–≥–∏ –ø—Ä–∏—à–ª–∏—Ç–µ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∏ senderPublicKey –≤ –±–æ—Ç. –≠—Ç–æ –ø–æ–∑–≤–æ–ª–∏—Ç –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, —É—á—ë–ª—Å—è –ª–∏ –≥–æ–ª–æ—Å.
""".strip(),
            "how_deg_works": """
–î–∏—Å—Ç–∞–Ω—Ü–∏–æ–Ω–Ω–æ–µ —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ–µ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ —ç—Ç–æ —Å–∏—Å—Ç–µ–º–∞ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è –æ–Ω–ª–∞–π–Ω, –±–µ–∑ –±—É–º–∞–∂–Ω–æ–≥–æ –±—é–ª–ª–µ—Ç–µ–Ω—è. –í—ã –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç–µ –±—Ä–∞—É–∑–µ—Ä, –≥–æ–ª–æ—Å—É–µ—Ç–µ, –≤–∞—à –≥–æ–ª–æ—Å —à–∏—Ñ—Ä—É–µ—Ç—Å—è, –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –∏ —Ö—Ä–∞–Ω–∏—Ç—Å—è —Ç–∞–º –¥–æ –æ–∫–æ–Ω—á–∞–Ω–∏—è –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è. –ü–æ—Å–ª–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è –≥–æ–ª–æ—Å–∞ –ø–æ–¥—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –∏ –æ–±—ä—è–≤–ª—è—é—Ç—Å—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã.

–°–∏—Å—Ç–µ–º–∞ –î–≠–ì –Ω–µ–ø—Ä–æ–∑—Ä–∞—á–Ω–∞ –∏ –Ω–µ–ø—Ä–æ–≤–µ—Ä—è–µ–º–∞. –° –ø–æ–º–æ—â—å—é –î–≠–ì –ª–µ–≥–∫–æ –ø–æ–¥–¥–µ–ª–∞—Ç—å –≥–æ–ª–æ—Å–∞ –∏ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ—Ç—Å–ª–µ–¥–∏—Ç—å —Ñ–∞–ª—å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏. –†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∏ –î–≠–ì –∏ —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –∏–∑–±–∏—Ä–∞—Ç–µ–ª—å–Ω–∞—è –∫–æ–º–∏—Å—Å–∏—è –Ω–µ –¥–∞—é—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –≤–Ω–µ—à–Ω–∏–º –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—è–º –∏ –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–º —ç–∫—Å–ø–µ—Ä—Ç–∞–º –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —á–µ—Å—Ç–Ω–æ—Å—Ç—å —Å–∏—Å—Ç–µ–º—ã.

–í 2021 –≥–æ–¥—É –î–≠–ì –ø–µ—Ä–µ–≤–µ—Ä–Ω—É–ª —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤—ã–±–æ—Ä–æ–≤ –¥–µ–ø—É—Ç–∞—Ç–æ–≤ –ì–æ—Å–¥—É–º—ã –≤ –ú–æ—Å–∫–≤–µ. –ü–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º –∞–Ω–∞–ª–∏–∑–∞ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö, –ø—Ä–æ–≤–µ–¥—ë–Ω–Ω–æ–≥–æ —ç–∫—Å–ø–µ—Ä—Ç–∞–º–∏, –≤—ã—è–≤–ª–µ–Ω—ã –º–∞—Å—Å–æ–≤—ã–µ —Ñ–∞–ª—å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ –≥–æ–ª–æ—Å–æ–≤ –≤ –ø–æ–ª—å–∑—É –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –æ—Ç –ø–∞—Ä—Ç–∏–∏ –≤–ª–∞—Å—Ç–∏.

–ü—Ä–æ —Ñ–∞–ª—å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ –≤ 2021 –≥–æ–¥—É: https://novayagazeta.ru/articles/2021/09/30/mandaty-polzuiutsia-vbrosom
–ü—Ä–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ —Ä–∞–±–æ—Ç—ã –î–≠–ì –≤ –ú–æ—Å–∫–≤–µ: https://habr.com/ru/articles/689002/
""".strip(),
        }[query_data]

        for image_id in image_ids:
            await context.bot.send_photo(
                chat_id=update.effective_chat.id,
                photo=image_id,
            )

        # After providing information, offer to go back to the main menu
        keyboard = _get_info_keyboard() + [
            [InlineKeyboardButton("–ù–∞–∑–∞–¥ –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data="back")]
        ]

        reply_markup = InlineKeyboardMarkup(keyboard)
        await context.bot.send_message(
            chat_id=update.effective_chat.id,
            text=text,
            reply_markup=reply_markup,
        )

        return ASKED_FOR_INFO_OPTIONS

    return await start(update, context)


def main() -> None:
    application = Application.builder().token(config.BOT_TOKEN).build()

    conv_handler = ConversationHandler(
        entry_points=[CommandHandler("start", start)],
        states={
            MENU: [
                CallbackQueryHandler(ask_for_info_options, pattern="^info$"),
                CallbackQueryHandler(
                    moscow_check_sid_handler, pattern="^moscow_check_sid$"
                ),
                CallbackQueryHandler(
                    redirect_to_dobrostat, pattern="^voting_in_person_redirect$"
                ),
            ],
            ASKED_FOR_INFO_OPTIONS: [
                CallbackQueryHandler(start, pattern="^back$"),
                CallbackQueryHandler(menu_handler),
            ],
            MOSCOW_ASKED_IF_CHECKED_SID: [
                CallbackQueryHandler(start, pattern="^back$"),
                CallbackQueryHandler(moscow_did_not_check_sid, pattern="^no$"),
                CallbackQueryHandler(
                    functools.partial(
                        menu_handler, data_override="voting_in_moscow_deg"
                    ),
                    pattern="did_not_check_get_info",
                ),
                CallbackQueryHandler(moscow_yes_i_checked_sid, pattern="^yes$"),
            ],
            MOSCOW_ASKED_FOR_SID: [
                MessageHandler(filters.TEXT, moscow_sid_message_handler),
                CallbackQueryHandler(start, pattern="^back$"),
                CallbackQueryHandler(
                    moscow_what_is_data_field_handler,
                    pattern="moscow_what_is_data_field",
                ),
            ],
        },
        fallbacks=[CommandHandler("start", start)],
    )

    application.add_handler(conv_handler)
    application.add_handler(MessageHandler(filters.PHOTO, photo_message_handler))

    application.run_polling()


if __name__ == "__main__":
    main()
